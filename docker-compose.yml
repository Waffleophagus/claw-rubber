services:
  claw-rubber:
    build:
      context: .
      dockerfile: Dockerfile
    image: claw-rubber:local
    container_name: claw-rubber
    restart: unless-stopped
    ports:
      - "${CLAWRUBBER_HOST_PORT:-3000}:3000"
    environment:
      CLAWRUBBER_BRAVE_API_KEY: ${CLAWRUBBER_BRAVE_API_KEY:?Set CLAWRUBBER_BRAVE_API_KEY in your shell or .env}
      PORT: 3000
      HOST: 0.0.0.0
      CLAWRUBBER_PROFILE: ${CLAWRUBBER_PROFILE:-strict}
      CLAWRUBBER_REDACT_URLS: ${CLAWRUBBER_REDACT_URLS:-true}
      CLAWRUBBER_FAIL_CLOSED: ${CLAWRUBBER_FAIL_CLOSED:-true}
      CLAWRUBBER_ALLOWLIST_DOMAINS: ${CLAWRUBBER_ALLOWLIST_DOMAINS:-}
      CLAWRUBBER_BLOCKLIST_DOMAINS: ${CLAWRUBBER_BLOCKLIST_DOMAINS:-}
      CLAWRUBBER_DB_PATH: /data/claw-rubber.db
      CLAWRUBBER_LOG_DIR: /data/logs
      CLAWRUBBER_RESULT_TTL_MINUTES: ${CLAWRUBBER_RESULT_TTL_MINUTES:-30}
      CLAWRUBBER_RETENTION_DAYS: ${CLAWRUBBER_RETENTION_DAYS:-30}
      CLAWRUBBER_LLM_JUDGE_ENABLED: ${CLAWRUBBER_LLM_JUDGE_ENABLED:-false}
      CLAWRUBBER_LLM_PROVIDER: ${CLAWRUBBER_LLM_PROVIDER:-openai}
      CLAWRUBBER_LLM_MODEL: ${CLAWRUBBER_LLM_MODEL:-gpt-4o-mini}
      CLAWRUBBER_OPENAI_API_KEY: ${CLAWRUBBER_OPENAI_API_KEY:-}
      CLAWRUBBER_OLLAMA_BASE_URL: ${CLAWRUBBER_OLLAMA_BASE_URL:-http://localhost:11434/api}
      CLAWRUBBER_WEBSITE_RENDERER_BACKEND: ${CLAWRUBBER_WEBSITE_RENDERER_BACKEND:-none}
      CLAWRUBBER_BROWSERLESS_URL: ${CLAWRUBBER_BROWSERLESS_URL:-http://browserless:3000}
      CLAWRUBBER_BROWSERLESS_TOKEN: ${CLAWRUBBER_BROWSERLESS_TOKEN:-}
      CLAWRUBBER_BROWSERLESS_TIMEOUT_MS: ${CLAWRUBBER_BROWSERLESS_TIMEOUT_MS:-12000}
      CLAWRUBBER_BROWSERLESS_WAIT_UNTIL: ${CLAWRUBBER_BROWSERLESS_WAIT_UNTIL:-networkidle}
      CLAWRUBBER_BROWSERLESS_WAIT_FOR_SELECTOR: ${CLAWRUBBER_BROWSERLESS_WAIT_FOR_SELECTOR:-}
      CLAWRUBBER_BROWSERLESS_MAX_HTML_BYTES: ${CLAWRUBBER_BROWSERLESS_MAX_HTML_BYTES:-1500000}
      CLAWRUBBER_BROWSERLESS_FALLBACK_TO_HTTP: ${CLAWRUBBER_BROWSERLESS_FALLBACK_TO_HTTP:-true}
      CLAWRUBBER_BROWSERLESS_BLOCK_ADS: ${CLAWRUBBER_BROWSERLESS_BLOCK_ADS:-true}
    volumes:
      - claw-rubber-data:/data
    networks:
      - claw-rubber-net

  browserless:
    image: browserless/chromium:latest
    container_name: claw-rubber-browserless
    restart: unless-stopped
    profiles:
      - browserless
    environment:
      TOKEN: ${CLAWRUBBER_BROWSERLESS_TOKEN:-}
      CONCURRENT: ${BROWSERLESS_CONCURRENT:-4}
      QUEUED: ${BROWSERLESS_QUEUED:-8}
      TIMEOUT: ${BROWSERLESS_TIMEOUT_MS:-30000}
      CORS: true
    ports:
      - "${BROWSERLESS_HOST_PORT:-3001}:3000"
    networks:
      - claw-rubber-net

volumes:
  claw-rubber-data:

networks:
  claw-rubber-net:
    driver: bridge
